{% extends "layout.html" %}
{% load static %}

{% block title %}
  Allotment List
{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/bus_list.css' %}">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
{% endblock %}

{% block content %}
  <div class="top-bar">
    <a href="{% url 'add_allotment' %}" class="add-btn">ADD ALLOTMENT +</a>
  </div>

  <form method="get" class="filter-form" style="flex-direction: column; align-items: flex-start;">

    <!-- Search Bar -->
    <div style="width: 100%;">
      <input type="text" name="search" 
             placeholder="Search..." 
             value="{{ request.GET.search }}" 
             class="styled-select"
             style="width: 100%; max-width: 400px; margin-bottom: 15px;" />
             <button type="submit" class="submit-btn">Search</button>

    </div>

    <!-- Dropdown Filters -->
    <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
      <select name="bus_no" class="styled-select searchable">
        <option value="">Select Bus No.</option>
        {% for no in bus_numbers %}
          <option value="{{ no }}" {% if request.GET.bus_no == no %}selected{% endif %}>{{ no }}</option>
        {% endfor %}
      </select>

      <select name="driver" class="styled-select searchable">
        <option value="">Select Driver</option>
        {% for d in drivers %}
          <option value="{{ d.id }}" {% if request.GET.driver == d.id|stringformat:"s" %}selected{% endif %}>{{ d.name }}</option>
        {% endfor %}
      </select>

      <select name="route" class="styled-select searchable">
        <option value="">Select Route</option>
        {% for r in routes %}
          <option value="{{ r.id }}" {% if request.GET.route == r.id|stringformat:"s" %}selected{% endif %}>{{ r.name }}</option>
        {% endfor %}
      </select>

      <button type="submit" class="submit-btn">Submit</button>
    </div>

  </form>

  {% if allotments %}
    <table>
      <thead>
        <tr>
          <th>Bus Number</th>
          <th>Driver</th>
          <th>Route</th>
          <th>Assigned Date</th>
        </tr>
      </thead>
      <tbody>
        {% for a in allotments %}
          <tr>
            <td><a href="{% url 'bus_detail' a.bus.number %}">{{ a.bus.number }}</a></td>
            <td><a href="{% url 'driver_detail' a.driver.D_license_number %}">{{ a.driver.name }}</a></td>
            <td>{{ a.route.name }}</td>
            <td>{{ a.assigned_date }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p class="no-data">No allotments found.</p>
  {% endif %}
{% endblock %}

{% block extra_js %}
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script>
    $(document).ready(function () {
      function matchCustom(params, data) {
        if ($.trim(params.term) === '') {
          return data;
        }
        if (data.text.toLowerCase().indexOf(params.term.toLowerCase()) > -1) {
          return data;
        }
        return null;
      }

      $('.searchable').select2({
        placeholder: "Select an option",
        allowClear: true,
        matcher: matchCustom
      });
    });
  </script>
{% endblock %}
